name: Wheel of nama

on:
  issue_comment:
    types: [created]

jobs:
  track_comments:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Run comment tracker
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_URL: 'https://github.com/netgoat-xyz/wall-of-names/issues/1'
        run: |
          node <<'JS'
          const fs = require('fs');
          const path = require('path');

          const payload = JSON.parse(process.env.GITHUB_EVENT_PATH);
          const comment = payload.comment;
          const issue = payload.issue;

          if(issue.html_url !== process.env.ISSUE_URL) {
            console.log("Not the target issue, skipping...");
            process.exit(0);
          }

          const username = comment.user.login;
          const commentBody = comment.body.replace(/\r\n/g,'\n');
          const date = new Date(comment.created_at).toISOString().split('T')[0];

          const userDir = path.join('people', username);
          if (!fs.existsSync(userDir)) fs.mkdirSync(userDir, { recursive: true });

          const filePath = path.join(userDir, `${date}.txt`);
          fs.appendFileSync(filePath, commentBody + '\n\n');

          // Update README
          const readmePath = 'README.md';
          let readme = fs.existsSync(readmePath) ? fs.readFileSync(readmePath, 'utf-8') : '';
          let peopleList = [];

          const peopleDir = path.join('people');
          if (fs.existsSync(peopleDir)) {
            peopleList = fs.readdirSync(peopleDir).filter(f => fs.lstatSync(path.join(peopleDir, f)).isDirectory());
            peopleList.sort((a,b)=> a.localeCompare(b,'en',{sensitivity:'base'}));
          }

          // Remove old list in README between markers if present
          const startMarker = '<!-- PEOPLE_LIST_START -->';
          const endMarker = '<!-- PEOPLE_LIST_END -->';
          const regex = new RegExp(`${startMarker}[\\s\\S]*${endMarker}`, 'm');

          const newList = `${startMarker}\n${peopleList.join('\n')}\n${endMarker}`;
          if(readme.match(regex)){
            readme = readme.replace(regex, newList);
          } else {
            readme += '\n\n' + newList;
          }

          fs.writeFileSync(readmePath, readme, 'utf-8');
          JS

      - name: Commit changes
        run: |
          git config --local user.name "github-actions[bot]"
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git add people README.md
          git commit -m "Update people from issue comments" || echo "No changes to commit"
          git push
